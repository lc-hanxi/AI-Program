<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åª’ä½“æ’­æ”¾</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
    }
    
    .player-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    
    video {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
    }
    
    img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .weather-container {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      z-index: 100;
    }
    
    /* æ’­æ”¾æ§åˆ¶é¢æ¿æ ·å¼ */
    .control-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      display: flex;
      flex-direction: column;
      z-index: 200;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .player-container:hover .control-panel {
      opacity: 1;
    }
    
    .control-panel .progress-container {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .control-panel .progress-bar {
      width: 100%;
      height: 5px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      cursor: pointer;
      position: relative;
    }
    
    .control-panel .progress {
      height: 100%;
      background: #ff0000;
      border-radius: 5px;
      width: 0%;
    }
    
    .control-buttons {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .control-buttons .left-controls {
      display: flex;
      align-items: center;
    }
    
    .control-buttons .right-controls {
      display: flex;
      align-items: center;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      margin: 0 5px;
      cursor: pointer;
      padding: 5px;
    }
    
    .volume-container {
      display: flex;
      align-items: center;
      width: 120px;
      margin-right: 15px;
    }
    
    .volume-slider {
      width: 70px;
      height: 5px;
      -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      outline: none;
      margin-left: 5px;
    }
    
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .time-display {
      font-size: 14px;
      color: white;
      margin: 0 10px;
    }
    
    .playback-rate-container {
      position: relative;
      margin-right: 15px;
    }
    
    .playback-rate-btn {
      background: none;
      border: none;
      color: white;
      font-size: 14px;
      cursor: pointer;
      padding: 5px 8px;
    }
    
    .rate-options {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 5px;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    
    .rate-option {
      padding: 5px 10px;
      color: white;
      cursor: pointer;
    }
    
    .rate-option:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .fullscreen-btn {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="player-container" id="player-container">
    <!-- æ§åˆ¶é¢æ¿å°†åœ¨è§†é¢‘æ’­æ”¾æ—¶æ·»åŠ  -->
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const fs = require('fs');
    
    let mediaElement = null;
    let playTimer = null;
    let mediaData = null;
    let progressInterval = null;
    let currentPlaybackRate = 1.0;
    let isEndEventSent = false; // æ ‡è®°æ˜¯å¦å·²å‘é€ç»“æŸäº‹ä»¶
    
    // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    function showDebug(msg) {
      const debugEl = document.getElementById('debug-info');
      if (debugEl) {
        debugEl.textContent = msg;
      }
      console.log('è°ƒè¯•ä¿¡æ¯:', msg);
    }
    
    // ç›‘å¬æ’­æ”¾åª’ä½“å‘½ä»¤
    ipcRenderer.on('play-media', (event, data) => {
      console.log('Received play command', data);
      mediaData = data;
      playMedia(data);
    });
    
    // ç›‘å¬æš‚åœå‘½ä»¤
    ipcRenderer.on('toggle-pause', () => {
      if (mediaElement && mediaElement.tagName === 'VIDEO') {
        if (mediaElement.paused) {
          mediaElement.play();
        } else {
          mediaElement.pause();
        }
      }
    });
    
    // æ’­æ”¾åª’ä½“
    function playMedia(data) {
      try {
        console.log('å¼€å§‹æ’­æ”¾åª’ä½“:', data.media.fileName);
        console.log('åª’ä½“æ•°æ®è¯¦æƒ…:', JSON.stringify(data));
        
        // æ¸…é™¤æ—§çš„è®¡æ—¶å™¨å’Œæ ‡è®°
        clearAllTimers();
        isEndEventSent = false;
        
        // è®°å½•åª’ä½“æ•°æ®
        mediaData = data;
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (!fs.existsSync(data.media.filePath)) {
          throw new Error(`åª’ä½“æ–‡ä»¶ä¸å­˜åœ¨: ${data.media.filePath}`);
        }
        
        // æ¸…ç©ºå®¹å™¨
        const container = document.getElementById('player-container');
        container.innerHTML = '';
        
        // åˆ›å»ºåª’ä½“å…ƒç´ 
        if (data.media.type === 'video') {
          console.log('åˆ›å»ºè§†é¢‘å…ƒç´ :', data.media.fileName);
          
          mediaElement = document.createElement('video');
          mediaElement.src = data.media.filePath;
          mediaElement.autoplay = true;
          mediaElement.controls = false; // ä¸æ˜¾ç¤ºåŸç”Ÿæ§ä»¶
          mediaElement.style.width = '100%';
          mediaElement.style.height = '100%';
          mediaElement.style.objectFit = 'contain'; // ä¿æŒå®½é«˜æ¯”
          
          // æ·»åŠ åª’ä½“åŠ è½½é”™è¯¯å¤„ç†
          mediaElement.onerror = (e) => {
            console.error('è§†é¢‘åŠ è½½é”™è¯¯:', e.target.error ? e.target.error.message : 'æœªçŸ¥é”™è¯¯');
            sendEndEvent();
          };
          
          // æ·»åŠ åˆ°å®¹å™¨
          container.appendChild(mediaElement);
          
          // åˆ›å»ºå¹¶æ·»åŠ æ§åˆ¶é¢æ¿
          createControlPanel(container);
          
          // ç›‘å¬è§†é¢‘åŠ è½½äº‹ä»¶ï¼Œè·å–çœŸå®æ—¶é•¿
          mediaElement.addEventListener('loadedmetadata', function() {
            const videoDuration = Math.floor(mediaElement.duration);
            console.log(`è§†é¢‘å·²åŠ è½½ï¼Œæ—¶é•¿: ${videoDuration}ç§’ï¼Œé…ç½®çš„æ—¶é•¿: ${data.media.duration || 'å®Œæ•´æ’­æ”¾'}ç§’`);
            
            // å¼€å§‹æ›´æ–°è¿›åº¦æ¡
            startProgressUpdate();
            
            // å¦‚æœè®¾ç½®äº†è‡ªå®šä¹‰æ—¶é•¿ï¼ˆ>0ï¼‰ï¼Œåˆ™ä½¿ç”¨è‡ªå®šä¹‰æ—¶é•¿
            if (data.media.duration && data.media.duration > 0) {
              console.log(`ä½¿ç”¨é…ç½®çš„æ’­æ”¾æ—¶é•¿: ${data.media.duration}ç§’`);
              // è®¾ç½®å®šæ—¶å™¨åœ¨æŒ‡å®šæ—¶é•¿åç»“æŸè§†é¢‘
              playTimer = setTimeout(() => {
                console.log('åˆ°è¾¾æŒ‡å®šæ’­æ”¾æ—¶é•¿ï¼Œç»“æŸæ’­æ”¾');
                sendEndEvent();
              }, data.media.duration * 1000);
            } else {
              // å®Œæ•´æ’­æ”¾æ¨¡å¼ - ä¸è®¾ç½®å®šæ—¶å™¨ï¼Œè®©è§†é¢‘æ’­æ”¾åˆ°è‡ªç„¶ç»“æŸ
              console.log('å®Œæ•´æ’­æ”¾æ¨¡å¼ï¼Œå°†æ’­æ”¾åˆ°è§†é¢‘ç»“æŸ');
            }
          });
          
          // ç›‘å¬æ’­æ”¾å¼€å§‹äº‹ä»¶
          mediaElement.addEventListener('playing', () => {
            console.log(`è§†é¢‘å¼€å§‹æ’­æ”¾: ${data.media.fileName}`);
          });
          
          // ç›‘å¬è§†é¢‘ç»“æŸäº‹ä»¶
          mediaElement.addEventListener('ended', () => {
            console.log('è§†é¢‘è‡ªç„¶ç»“æŸ');
            if (playTimer) {
              clearTimeout(playTimer);
              playTimer = null;
            }
            sendEndEvent();
          });
          
        } else { // å›¾ç‰‡
          console.log(`åˆ›å»ºå›¾ç‰‡å…ƒç´ : ${data.media.fileName}`);
          
          mediaElement = document.createElement('img');
          mediaElement.src = data.media.filePath;
          mediaElement.style.width = '100%';
          mediaElement.style.height = '100%';
          mediaElement.style.objectFit = 'contain'; // ä¿æŒå®½é«˜æ¯”
          
          // æ·»åŠ åˆ°å®¹å™¨
          container.appendChild(mediaElement);
          
          // å›¾ç‰‡åŠ è½½å®Œæˆ
          mediaElement.onload = () => {
            console.log(`å›¾ç‰‡åŠ è½½å®Œæˆ: ${data.media.fileName}`);
          };
          
          // å›¾ç‰‡åŠ è½½é”™è¯¯
          mediaElement.onerror = () => {
            console.error(`å›¾ç‰‡åŠ è½½é”™è¯¯: ${data.media.fileName}`);
            sendEndEvent();
          };
          
          // å›¾ç‰‡å¿…é¡»è®¾ç½®æ˜¾ç¤ºæ—¶é•¿ï¼Œè‡³å°‘10ç§’
          const duration = data.media.duration && data.media.duration >= 10 ? data.media.duration : 10;
          console.log(`å›¾ç‰‡æ˜¾ç¤ºæ—¶é•¿: ${duration}ç§’`);
          
          // å›¾ç‰‡æ˜¾ç¤ºæŒ‡å®šæ—¶é—´åç»“æŸ
          playTimer = setTimeout(() => {
            console.log('å›¾ç‰‡æ˜¾ç¤ºæ—¶é—´åˆ°ï¼Œç»“æŸæ˜¾ç¤º');
            sendEndEvent();
          }, duration * 1000);
        }
        
        // åº”ç”¨äº®åº¦
        if (data.config && data.config.screen) {
          mediaElement.style.filter = `brightness(${data.config.screen.brightness}%)`;
        }
        
        // æ˜¾ç¤ºå¤©æ°”ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (data.config && data.config.weather && data.config.weather.enabled) {
          showWeather(data.config.weather);
        }
      } catch (error) {
        console.error('æ’­æ”¾åª’ä½“é”™è¯¯:', error);
        
        // åœ¨é”™è¯¯åä¹Ÿè¦å‘é€ç»“æŸäº‹ä»¶ï¼Œç¡®ä¿èƒ½ç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ª
        setTimeout(() => {
          sendEndEvent();
        }, 1000);
      }
    }
    
    // åˆ›å»ºæ§åˆ¶é¢æ¿
    function createControlPanel(container) {
      if (!mediaElement || mediaElement.tagName !== 'VIDEO') return;
      
      const controlPanel = document.createElement('div');
      controlPanel.className = 'control-panel';
      controlPanel.innerHTML = `
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress" id="video-progress"></div>
          </div>
        </div>
        <div class="control-buttons">
          <div class="left-controls">
            <button class="control-btn play-pause-btn">â¸</button>
            <span class="time-display">00:00 / 00:00</span>
          </div>
          <div class="right-controls">
            <div class="volume-container">
              <button class="control-btn volume-btn">ğŸ”Š</button>
              <input type="range" class="volume-slider" min="0" max="1" step="0.1" value="1">
            </div>
            <div class="playback-rate-container">
              <button class="playback-rate-btn">1.0x</button>
              <div class="rate-options">
                <div class="rate-option" data-rate="0.5">0.5x</div>
                <div class="rate-option" data-rate="0.75">0.75x</div>
                <div class="rate-option" data-rate="1.0">1.0x</div>
                <div class="rate-option" data-rate="1.25">1.25x</div>
                <div class="rate-option" data-rate="1.5">1.5x</div>
                <div class="rate-option" data-rate="2.0">2.0x</div>
              </div>
            </div>
            <button class="control-btn fullscreen-btn">â›¶</button>
          </div>
        </div>
      `;
      
      container.appendChild(controlPanel);
      
      // è®¾ç½®æ§åˆ¶æŒ‰é’®äº‹ä»¶
      setupControlEvents(controlPanel);
    }
    
    // è®¾ç½®æ§åˆ¶é¢æ¿äº‹ä»¶
    function setupControlEvents(panel) {
      // æ’­æ”¾/æš‚åœæŒ‰é’®
      const playPauseBtn = panel.querySelector('.play-pause-btn');
      playPauseBtn.addEventListener('click', () => {
        if (mediaElement.paused) {
          mediaElement.play();
          playPauseBtn.textContent = 'â¸';
        } else {
          mediaElement.pause();
          playPauseBtn.textContent = 'â–¶';
        }
      });
      
      // è¿›åº¦æ¡ç‚¹å‡»
      const progressBar = panel.querySelector('.progress-bar');
      progressBar.addEventListener('click', (e) => {
        const rect = progressBar.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        mediaElement.currentTime = pos * mediaElement.duration;
        updateProgress();
      });
      
      // éŸ³é‡æ§åˆ¶
      const volumeSlider = panel.querySelector('.volume-slider');
      const volumeBtn = panel.querySelector('.volume-btn');
      
      volumeSlider.value = mediaElement.volume;
      
      volumeSlider.addEventListener('input', () => {
        mediaElement.volume = volumeSlider.value;
        if (mediaElement.volume === 0) {
          volumeBtn.textContent = 'ğŸ”‡';
        } else {
          volumeBtn.textContent = 'ğŸ”Š';
        }
      });
      
      volumeBtn.addEventListener('click', () => {
        if (mediaElement.volume > 0) {
          mediaElement.volume = 0;
          volumeSlider.value = 0;
          volumeBtn.textContent = 'ğŸ”‡';
        } else {
          mediaElement.volume = 1;
          volumeSlider.value = 1;
          volumeBtn.textContent = 'ğŸ”Š';
        }
      });
      
      // æ’­æ”¾é€Ÿç‡
      const rateBtn = panel.querySelector('.playback-rate-btn');
      const rateOptions = panel.querySelector('.rate-options');
      
      rateBtn.addEventListener('click', () => {
        rateOptions.style.display = rateOptions.style.display === 'flex' ? 'none' : 'flex';
      });
      
      document.addEventListener('click', (e) => {
        if (!rateBtn.contains(e.target) && !rateOptions.contains(e.target)) {
          rateOptions.style.display = 'none';
        }
      });
      
      const rateOptionBtns = panel.querySelectorAll('.rate-option');
      rateOptionBtns.forEach(option => {
        option.addEventListener('click', () => {
          const rate = parseFloat(option.getAttribute('data-rate'));
          mediaElement.playbackRate = rate;
          currentPlaybackRate = rate;
          rateBtn.textContent = `${rate}x`;
          rateOptions.style.display = 'none';
        });
      });
      
      // å…¨å±æŒ‰é’®
      const fullscreenBtn = panel.querySelector('.fullscreen-btn');
      fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
          // é€šçŸ¥ä¸»è¿›ç¨‹é€€å‡ºå…¨å±æ¨¡å¼
          ipcRenderer.send('exit-fullscreen');
        }
      });
    }
    
    // å¼€å§‹å®šæ—¶æ›´æ–°è¿›åº¦æ¡
    function startProgressUpdate() {
      // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      
      progressInterval = setInterval(() => {
        updateProgress();
        updateTimeDisplay();
      }, 1000);
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress() {
      if (!mediaElement || mediaElement.tagName !== 'VIDEO') return;
      
      const progress = document.getElementById('video-progress');
      if (progress && !isNaN(mediaElement.duration) && mediaElement.duration > 0) {
        const percent = (mediaElement.currentTime / mediaElement.duration) * 100;
        progress.style.width = `${percent}%`;
      }
    }
    
    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateTimeDisplay() {
      if (!mediaElement || mediaElement.tagName !== 'VIDEO') return;
      
      const timeDisplay = document.querySelector('.time-display');
      if (timeDisplay && !isNaN(mediaElement.duration)) {
        const currentTime = formatTime(mediaElement.currentTime);
        const totalTime = formatTime(mediaElement.duration);
        timeDisplay.textContent = `${currentTime} / ${totalTime}`;
      }
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
      seconds = Math.floor(seconds);
      const minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // æ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
    function clearAllTimers() {
      if (playTimer) {
        clearTimeout(playTimer);
        playTimer = null;
      }
      
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }
    
    // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯
    function showWeather(weatherConfig) {
      // ç§»é™¤æ—§çš„å¤©æ°”å®¹å™¨
      const oldWeather = document.querySelector('.weather-container');
      if (oldWeather) {
        oldWeather.remove();
      }
      
      // åˆ›å»ºæ–°çš„å¤©æ°”å®¹å™¨
      const weatherContainer = document.createElement('div');
      weatherContainer.className = 'weather-container';
      
      // æ¨¡æ‹Ÿå¤©æ°”æ•°æ®
      const temperature = Math.floor(Math.random() * 30) + 5; // 5-35åº¦
      const humidity = Math.floor(Math.random() * 65) + 35; // 35-100%
      const weathers = ['æ™´', 'å¤šäº‘', 'é˜´', 'å°é›¨', 'ä¸­é›¨', 'å¤§é›¨', 'é›·é˜µé›¨', 'å°é›ª', 'ä¸­é›ª', 'å¤§é›ª'];
      const weather = weathers[Math.floor(Math.random() * weathers.length)];
      
      // è®¾ç½®å¤©æ°”å†…å®¹
      weatherContainer.innerHTML = `
        <div style="margin-bottom: 5px; font-weight: bold;">${weatherConfig.city} å¤©æ°”</div>
        <div>${weather} ${temperature}Â°C</div>
        <div>æ¹¿åº¦: ${humidity}%</div>
        <div style="font-size: 12px; margin-top: 5px;">${new Date().toLocaleTimeString()}</div>
      `;
      
      document.body.appendChild(weatherContainer);
    }
    
    // å‘é€ç»“æŸäº‹ä»¶
    function sendEndEvent() {
      if (!mediaData || isEndEventSent) return;
      
      console.log('Sending media ended event', mediaData);
      
      // è®¾ç½®å·²å‘é€æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤å‘é€
      isEndEventSent = true;
      
      // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
      clearAllTimers();
      
      // è®°å½•è¦å‘é€çš„æ•°æ®
      const dataToSend = {
        index: mediaData.index,
        isSpecialContent: mediaData.isSpecialContent,
        specialType: mediaData.specialType
      };
      
      // æ¸…é™¤å½“å‰åª’ä½“å¼•ç”¨ï¼Œé˜²æ­¢é‡å¤è§¦å‘
      mediaData = null;
      
      // å¦‚æœæœ‰åª’ä½“å…ƒç´ ï¼Œåœæ­¢æ’­æ”¾
      if (mediaElement) {
        if (mediaElement.tagName === 'VIDEO') {
          mediaElement.pause();
          mediaElement.src = '';
        }
        mediaElement = null;
      }
      
      // å‘é€ç»“æŸäº‹ä»¶åˆ°ä¸»è¿›ç¨‹
      try {
        ipcRenderer.send('media-ended', dataToSend);
        
        // å»¶è¿Ÿå…³é—­çª—å£ï¼Œç¡®ä¿æ¶ˆæ¯å‘é€æˆåŠŸ
        setTimeout(() => {
          console.log('å…³é—­æ’­æ”¾å™¨çª—å£');
          window.close();
        }, 500);
      } catch (error) {
        console.error('å‘é€åª’ä½“ç»“æŸäº‹ä»¶é”™è¯¯:', error);
      }
    }
    
    // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
    document.addEventListener('keydown', (e) => {
      // ESCé”® - é€€å‡ºå…¨å±
      if (e.key === 'Escape') {
        console.log('ESC key pressed, exiting fullscreen');
        try {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          }
          // é€šçŸ¥ä¸»è¿›ç¨‹é€€å‡ºå…¨å±
          ipcRenderer.send('exit-fullscreen');
        } catch (error) {
          console.error('Error exiting fullscreen:', error);
        }
        e.preventDefault();
      }
      
      // ç©ºæ ¼é”® - åˆ‡æ¢æ’­æ”¾/æš‚åœ
      if (e.key === ' ' && mediaElement && mediaElement.tagName === 'VIDEO') {
        if (mediaElement.paused) {
          mediaElement.play();
          const playPauseBtn = document.querySelector('.play-pause-btn');
          if (playPauseBtn) playPauseBtn.textContent = 'â¸';
        } else {
          mediaElement.pause();
          const playPauseBtn = document.querySelector('.play-pause-btn');
          if (playPauseBtn) playPauseBtn.textContent = 'â–¶';
        }
        e.preventDefault();
      }
    });
    
    // çª—å£å…³é—­å‰æ¸…ç†èµ„æº
    window.addEventListener('beforeunload', () => {
      clearAllTimers();
      
      if (mediaElement && mediaElement.tagName === 'VIDEO') {
        mediaElement.pause();
        mediaElement.src = '';
      }
      
      // ç¡®ä¿åœ¨çª—å£å…³é—­å‰å‘é€ç»“æŸäº‹ä»¶
      if (mediaData && !isEndEventSent) {
        sendEndEvent();
      }
    });
  </script>
</body>
</html> 